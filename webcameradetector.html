<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム物体検出アプリ (シングルファイル版)</title>
    
    <!-- CSSをHTMLに埋め込み -->
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            height: 100vh;
            box-sizing: border-box;
        }
        .panel {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        h1 {
            color: #333;
            text-align: center;
            width: 100%;
        }
        .video-wrapper {
            position: relative;
            width: 90%;
            max-width: 640px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #webcam, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #webcam {
            position: relative; /* to maintain aspect ratio */
            display: block;
        }
        #canvas {
            z-index: 10;
        }
        #wordcloud-wrapper {
            width: 90%;
            height: 80%;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #wordcloud {
            width: 100% !important;
            height: 100% !important;
        }
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: #555;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            .panel {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel video-container">
            <h1>Webcam Feed</h1>
            <div class="video-wrapper">
                <video id="webcam" autoplay playsinline muted></video>
                <canvas id="canvas"></canvas>
            </div>
             <div id="loader" class="loader">モデルを読み込んでいます...</div>
        </div>
        <div class="panel wordcloud-container">
            <h1>Detected Objects</h1>
            <div id="wordcloud-wrapper">
                <canvas id="wordcloud"></canvas>
            </div>
        </div>
    </div>

    <!-- 外部ライブラリをCDNから読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

    <!-- JavaScriptをHTMLに埋め込み -->
    <script>
        const webcamElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');
        const wordcloudCanvas = document.getElementById('wordcloud');
        const loaderElement = document.getElementById('loader');
        const canvasCtx = canvasElement.getContext('2d');

        let model;
        let detectedObjects = {};

        // COCO-SSDのラベル配列 (YOLOモデルに合わせて変更してください)
        const cocoSsdLabels = [
            'person', 'bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat', 'traffic light',
            'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow',
            'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee',
            'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard',
            'tennis racket', 'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple',
            'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 'couch',
            'potted plant', 'bed', 'dining table', 'toilet', 'tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone',
            'microwave', 'oven', 'toaster', 'sink', 'refrigerator', 'book', 'clock', 'vase', 'scissors', 'teddy bear',
            'hair drier', 'toothbrush'
        ];
        
        // ウェブカメラをセットアップ
        async function setupWebcam() {
            return new Promise((resolve, reject) => {
                const navigatorAny = navigator;
                navigator.getUserMedia = navigator.getUserMedia ||
                    navigatorAny.webkitGetUserMedia || navigatorAny.mozGetUserMedia ||
                    navigatorAny.msGetUserMedia;
                if (navigator.getUserMedia) {
                    navigator.getUserMedia({ video: { facingMode: 'environment' } }, // 背面カメラを優先
                        stream => {
                            webcamElement.srcObject = stream;
                            webcamElement.addEventListener('loadeddata', () => {
                                resolve();
                            }, false);
                        },
                        error => {
                            console.error("Webcam access error:", error);
                            loaderElement.innerText = "ウェブカメラにアクセスできません。";
                            reject();
                        });
                } else {
                    loaderElement.innerText = "お使いのブラウザはウェブカメラに対応していません。";
                    reject();
                }
            });
        }
        
        // 物体検出をフレームごとに行う
        async function detectFrame() {
            if (!model) return;

            tf.engine().startScope();
            
            // ビデオの現在のサイズを取得
            const videoWidth = webcamElement.videoWidth;
            const videoHeight = webcamElement.videoHeight;

            // キャンバスのサイズをビデオに合わせる
            canvasElement.width = videoWidth;
            canvasElement.height = videoHeight;

            const input = tf.browser.fromPixels(webcamElement).resizeBilinear([640, 640]).div(255.0).expandDims(0);
            const predictions = await model.executeAsync(input);

            // モデルの出力形式は変換したモデルに依存します。これは一般的な例です。
            // [boxes, scores, classes, valid_detections]
            const [boxes, scores, classes, valid_detections] = predictions;
            const boxes_data = boxes.dataSync();
            const scores_data = scores.dataSync();
            const classes_data = classes.dataSync();
            const valid_detections_data = valid_detections.dataSync()[0];

            // 以前の描画をクリア
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            const currentDetections = {};

            for (let i = 0; i < valid_detections_data; ++i) {
                if (scores_data[i] < 0.5) { // 信頼度が50%未満のものは無視
                    continue;
                }
                
                let [x1, y1, x2, y2] = boxes_data.slice(i * 4, (i + 1) * 4);
                x1 *= canvasElement.width;
                x2 *= canvasElement.width;
                y1 *= canvasElement.height;
                y2 *= canvasElement.height;
                const width = x2 - x1;
                const height = y2 - y1;
                const klass = cocoSsdLabels[classes_data[i]];
                const score = scores_data[i].toFixed(2);

                // バウンディングボックスとラベルを描画
                canvasCtx.strokeStyle = "#00FFFF";
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeRect(x1, y1, width, height);

                canvasCtx.fillStyle = "#00FFFF";
                const font = "18px Arial";
                canvasCtx.font = font;
                const textWidth = canvasCtx.measureText(klass + " " + score).width;
                canvasCtx.fillRect(x1 -1, y1 - 20, textWidth + 4, 22);

                canvasCtx.fillStyle = "#000000";
                canvasCtx.fillText(`${klass} ${score}`, x1 + 1, y1 - 5);

                // 検出されたオブジェクトをカウント
                if (currentDetections[klass]) {
                    currentDetections[klass]++;
                } else {
                    currentDetections[klass] = 1;
                }
            }

            // 全体のオブジェクトカウントを更新
            for(const key in currentDetections) {
                if(detectedObjects[key]){
                    detectedObjects[key]++;
                } else {
                    detectedObjects[key] = 1;
                }
            }

            tf.engine().endScope();
            requestAnimationFrame(detectFrame);
        }
        
        // ワードクラウドを更新
        function updateWordCloud() {
            const list = Object.entries(detectedObjects).map(([text, count]) => {
                // 対数スケールなどで重みを調整すると見やすくなる
                const weight = Math.log2(count + 1) * 5;
                return [text, weight];
            });

            if (list.length > 0) {
                WordCloud(wordcloudCanvas, { 
                    list: list,
                    backgroundColor: '#ffffff',
                    color: 'random-dark',
                    weightFactor: 2.5 // 文字サイズを調整
                });
            }
        }
        
        // メイン処理
        async function main() {
            try {
                await setupWebcam();
                console.log("Webcam setup complete.");

                console.log("Loading model...");
                // **重要**: 'model/model.json' はサーバー上のパスです。
                model = await tf.loadGraphModel('model/model.json');
                console.log("Model loaded.");
                loaderElement.style.display = 'none'; // ローダーを非表示に

                detectFrame(); // 検出ループを開始
                setInterval(updateWordCloud, 3000); // 3秒ごとにワードクラウドを更新
            } catch (e) {
                console.error(e);
            }
        }

        main();

    </script>
</body>
</html>