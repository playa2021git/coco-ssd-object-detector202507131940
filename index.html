<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム物体検出アプリ (シングルファイル版)</title>
    
    <!-- CSSをHTMLに埋め込み -->
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            height: 100vh;
            box-sizing: border-box;
        }
        .panel {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        h1 {
            color: #333;
            text-align: center;
            width: 100%;
        }
        .video-wrapper {
            position: relative;
            width: 90%;
            max-width: 640px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #webcam, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #webcam {
            position: relative; /* to maintain aspect ratio */
            display: block;
        }
        #canvas {
            z-index: 10;
        }
        #wordcloud-wrapper {
            width: 90%;
            height: 80%;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #wordcloud {
            width: 100% !important;
            height: 100% !important;
        }
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: #555;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            .panel {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel video-container">
            <h1>Webcam Feed</h1>
            <div class="video-wrapper">
                <video id="webcam" autoplay playsinline muted></video>
                <canvas id="canvas"></canvas>
            </div>
             <div id="loader" class="loader">モデルを読み込んでいます...</div>
        </div>
        <div class="panel wordcloud-container">
            <h1>Detected Objects</h1>
            <button onclick="resetWordCloud()">Reset Cloud</button> <!-- ← この行を追加 -->
            <div id="wordcloud-wrapper">
                <canvas id="wordcloud"></canvas>
            </div>
        </div>
    </div>

    <!-- 外部ライブラリをCDNから読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

    <!-- JavaScriptをHTMLに埋め込み -->
   <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script> <!-- ★新しい公式ライブラリ★ -->
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

<!-- JavaScriptをHTMLに埋め込み -->
<script>
    const webcamElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    const wordcloudCanvas = document.getElementById('wordcloud');
    const loaderElement = document.getElementById('loader');
    const canvasCtx = canvasElement.getContext('2d');

    let model;
    let detectedObjects = {};

    // ワードクラウドをリセットする関数
    function resetWordCloud() {
        detectedObjects = {};
        const context = wordcloudCanvas.getContext('2d');
        if (context) {
            context.clearRect(0, 0, wordcloudCanvas.width, wordcloudCanvas.height);
        }
        console.log("Word cloud has been reset.");
    }
    
    async function setupWebcam() {
        return new Promise((resolve, reject) => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                    .then(stream => {
                        webcamElement.srcObject = stream;
                        webcamElement.addEventListener('loadeddata', resolve, false);
                    })
                    .catch(error => {
                        console.error("Webcam access error:", error);
                        loaderElement.innerText = "ウェブカメラにアクセスできません。";
                        reject();
                    });
            } else {
                loaderElement.innerText = "お使いのブラウザはウェブカメラに対応していません。";
                reject();
            }
        });
    }

    // Google公式モデル(COCO-SSD)用に書き換えた、新しい物体検出関数
    async function detectFrame() {
        if (!model) return;

        // ★★★ 予測の実行が非常にシンプルになります！ ★★★
        const predictions = await model.detect(webcamElement);

        // 描画の前にキャンバスをクリア
        canvasElement.width = webcamElement.videoWidth;
        canvasElement.height = webcamElement.videoHeight;
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        const currentDetections = {};
        
        // ★★★ 予測結果の処理も、非常にシンプルになります！ ★★★
        for (let i = 0; i < predictions.length; i++) {
            const prediction = predictions[i];
            const [x, y, width, height] = prediction.bbox;
            const klass = prediction.class;
            const score = prediction.score;

            // バウンディングボックスを描画
            canvasCtx.strokeStyle = "#00FF00";
            canvasCtx.lineWidth = 4; // 少し太くして見やすく
            canvasCtx.strokeRect(x, y, width, height);

            // ラベルを描画
            canvasCtx.fillStyle = "#00FF00";
            const font = "20px Arial";
            canvasCtx.font = font;
            const text = `${klass} ${score.toFixed(2)}`;
            const textWidth = canvasCtx.measureText(text).width;
            canvasCtx.fillRect(x, y, textWidth + 8, 24);
            canvasCtx.fillStyle = "#000000";
            canvasCtx.fillText(text, x + 4, y + 18);
            
            // ワードクラウド用のカウント
            if (currentDetections[klass]) {
                currentDetections[klass]++;
            } else {
                currentDetections[klass] = 1;
            }
        }
        
        // 全体のカウントを更新
        for(const key in currentDetections) {
            if(detectedObjects[key]){
                detectedObjects[key]++;
            } else {
                detectedObjects[key] = 1;
            }
        }

        requestAnimationFrame(detectFrame);
    }
    
    function updateWordCloud() {
        const list = Object.entries(detectedObjects).map(([text, count]) => {
            const weight = Math.log2(count + 1) * 8; // 少し大きく
            return [text, weight];
        });

        if (list.length > 0) {
            WordCloud(wordcloudCanvas, { 
                list: list,
                backgroundColor: '#ffffff',
                color: 'random-dark',
                weightFactor: 2.5
            });
        }
    }
    
    // メイン処理も、モデルの読み込み方が変わります
    async function main() {
        try {
            await setupWebcam();
            console.log("Webcam setup complete.");

            console.log("Loading COCO-SSD model...");
            loaderElement.innerText = "公式モデルを読み込んでいます...";
            
            // ★★★ モデルの読み込み方が、この1行に変わります！ ★★★
            model = await cocoSsd.load(); 
            
            console.log("Model loaded.");
            loaderElement.style.display = 'none';

            detectFrame();
            setInterval(updateWordCloud, 3000);
        } catch (e) {
            console.error(e);
            loaderElement.innerText = "エラーが発生しました。コンソールを確認してください。";
        }
    }

    main();
</script>
</body>
</html>
