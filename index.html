<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム物体検出アプリ (シングルファイル版)</title>
    
    <!-- CSSをHTMLに埋め込み -->
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            height: 100vh;
            box-sizing: border-box;
        }
        .panel {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        h1 {
            color: #333;
            text-align: center;
            width: 100%;
        }
        .video-wrapper {
            position: relative;
            width: 90%;
            max-width: 640px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #webcam, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #webcam {
            position: relative; /* to maintain aspect ratio */
            display: block;
        }
        #canvas {
            z-index: 10;
        }
        #wordcloud-wrapper {
            width: 90%;
            height: 80%;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #wordcloud {
            width: 100% !important;
            height: 100% !important;
        }
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: #555;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            .panel {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel video-container">
            <h1>Webcam Feed</h1>
            <div class="video-wrapper">
                <video id="webcam" autoplay playsinline muted></video>
                <canvas id="canvas"></canvas>
            </div>
             <div id="loader" class="loader">モデルを読み込んでいます...</div>
        </div>
        <div class="panel wordcloud-container">
            <h1>Detected Objects</h1>
            <div id="wordcloud-wrapper">
                <canvas id="wordcloud"></canvas>
            </div>
        </div>
    </div>

    <!-- 外部ライブラリをCDNから読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

    <!-- JavaScriptをHTMLに埋め込み -->
   <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
<!-- JavaScriptをHTMLに埋め込み -->
<script>
const webcamElement = document.getElementById('webcam');
const canvasElement = document.getElementById('canvas');
const wordcloudCanvas = document.getElementById('wordcloud');
const loaderElement = document.getElementById('loader');
const canvasCtx = canvasElement.getContext('2d');

let model;
let detectedObjects = {};

const cocoSsdLabels = [
'person', 'bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat', 'traffic light',
'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow',
'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee',
'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard',
'tennis racket', 'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple',
'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 'couch',
'potted plant', 'bed', 'dining table', 'toilet', 'tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone',
'microwave', 'oven', 'toaster', 'sink', 'refrigerator', 'book', 'clock', 'vase', 'scissors', 'teddy bear',
'hair drier', 'toothbrush'
];

async function setupWebcam() {
return new Promise((resolve, reject) => {
const navigatorAny = navigator;
navigator.getUserMedia = navigator.getUserMedia ||
navigatorAny.webkitGetUserMedia || navigatorAny.mozGetUserMedia ||
navigatorAny.msGetUserMedia;
if (navigator.getUserMedia) {
navigator.getUserMedia({ video: { facingMode: 'user' } },
stream => {
webcamElement.srcObject = stream;
webcamElement.addEventListener('loadeddata', () => {
resolve();
}, false);
},
error => {
console.error("Webcam access error:", error);
loaderElement.innerText = "ウェブカメラにアクセスできません。";
reject();
});
} else {
loaderElement.innerText = "お使いのブラウザはウェブカメラに対応していません。";
reject();
}
});
}

// 物体検出をフレームごとに行う (完成版)
async function detectFrame() {
if (!model) return;

tf.engine().startScope();

const videoWidth = webcamElement.videoWidth;
const videoHeight = webcamElement.videoHeight;
canvasElement.width = videoWidth;
canvasElement.height = videoHeight;

const input = tf.browser.fromPixels(webcamElement).resizeBilinear([640, 640]).div(255.0).expandDims(0).transpose([0, 3, 1, 2]);

const predictions = await model.executeAsync(input);
const output = predictions.transpose([0, 2, 1]).squeeze(0);

const boxes = [];
const scores = [];
const class_indices = [];
const confidenceThreshold = 0.25;
const iouThreshold = 0.45;

for (let i = 0; i < output.shape[0]; i++) {
const detection = output.slice(i, 1).squeeze();
const obj_score = detection.slice(4, 1).dataSync()[0];

if (obj_score > confidenceThreshold) {
const class_probabilities = detection.slice(5);
const class_index = class_probabilities.argMax().dataSync()[0];
const score = obj_score * class_probabilities.max().dataSync()[0];

if (score > confidenceThreshold) {
const [x_center, y_center, width, height] = detection.slice(0, 4).dataSync();
boxes.push([
y_center - height / 2, // y1
x_center - width / 2, // x1
y_center + height / 2, // y2
x_center + width / 2 // x2
]);
scores.push(score);
class_indices.push(class_index);
}
}
}

canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

if (boxes.length > 0) {
const nms_indices = await tf.image.nonMaxSuppressionAsync(boxes, scores, 50, iouThreshold, confidenceThreshold);
const selected_indices = nms_indices.dataSync();

const currentDetections = {};

for (const index of selected_indices) {
const [y1, x1, y2, x2] = boxes[index];
const score = scores[index];
let klass = cocoSsdLabels[class_indices[index]];

// ★★★ ここが修正点！ ★★★
// もし辞書にない単語(undefined)だったら、'unknown'として扱う
if (klass === undefined) {
klass = 'unknown';
}

const box_x = x1 * canvasElement.width;
const box_y = y1 * canvasElement.height;
const box_width = (x2 - x1) * canvasElement.width;
const box_height = (y2 - y1) * canvasElement.height;

canvasCtx.strokeStyle = "#00FF00";
canvasCtx.lineWidth = 2;
canvasCtx.strokeRect(box_x, box_y, box_width, box_height);

canvasCtx.fillStyle = "#00FF00";
const font = "18px Arial";
canvasCtx.font = font;
const text = `${klass} ${score.toFixed(2)}`;
const textWidth = canvasCtx.measureText(text).width;
canvasCtx.fillRect(box_x - 1, box_y - 20, textWidth + 4, 22);

canvasCtx.fillStyle = "#000000";
canvasCtx.fillText(text, box_x + 1, box_y - 5);

if (currentDetections[klass]) {
currentDetections[klass]++;
} else {
currentDetections[klass] = 1;
}
}

for(const key in currentDetections) {
if(detectedObjects[key]){
detectedObjects[key]++;
} else {
detectedObjects[key] = 1;
}
}
}

tf.engine().endScope();
requestAnimationFrame(detectFrame);
}

function updateWordCloud() {
const list = Object.entries(detectedObjects).map(([text, count]) => {
const weight = Math.log2(count + 1) * 5;
return [text, weight];
});

if (list.length > 0) {
WordCloud(wordcloudCanvas, {
list: list,
backgroundColor: '#ffffff',
color: 'random-dark',
weightFactor: 2.5
});
}
}

async function main() {
try {
await setupWebcam();
console.log("Webcam setup complete.");

console.log("Loading model...");
model = await tf.loadGraphModel('model/model.json');
console.log("Model loaded.");
loaderElement.style.display = 'none';

detectFrame();
setInterval(updateWordCloud, 3000);
} catch (e) {
console.error(e);
loaderElement.innerText = "エラーが発生しました。コンソールを確認してください。";
}
}

main();
</script>
</body>
</html>
